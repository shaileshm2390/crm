<div class="card">

    <section data-ng-init="findOneByRfqId()" ng-show="rfq.id != null  && validatePermission">
        <h1>
            RFQ Detail - {{rfq.subject | capitalize}}
            <span class="row pull-right">
                <span>
                    <a class="btn btn-danger" ui-sref="viewBuyer({buyerId : rfq.BuyerId, customerId: rfq.Buyer.CustomerId})">Cancel</a>
                </span>
            </span>
        </h1>


        <div class="clear clearfix"></div><br />

        <div class="row">
            <div class="col col-lg-6" style="background-color: linen; min-height:200px">
                <div class="clear clearfix"></div><br />
                <div class="row">
                    <div class="col col-lg-8">
                        <p><label>Buyer: </label><strong>{{rfq.Buyer.name}}</strong></p>
                        <p><label>Email: </label><strong>{{rfq.Buyer.email}}</strong></p>
                    </div>
                    <div class="col col-lg-4">
                        <p><label>Company: </label><strong>{{rfq.Buyer.Customer.company}}</strong></p>
                        <p><label>Owner: </label><strong>{{rfq.Buyer.Customer.name}}</strong></p>
                    </div>
                </div>
                <div class="clear clearfix"></div><hr />
                <div class="row">
                    <label class="col-lg-3">Assigned: </label>
                    <div class="col-lg-9">
                        <div ng-hide="isPoReceived(rfq)">
                            <select ng-controller="UsersController" ng-init="find()" class="form-control ddlUser" required name="UserId" data-ng-model="rfq.UserId" ng-show="global.user.isAdmin">
                                <option value="">Select </option>
                                <option ng-repeat="user in users" value="{{user.id}}">{{user.firstName + " " + user.lastName}} ({{user.email}})</option>
                            </select>

                            <div ng-show="!global.user.isAdmin">
                                <strong>{{(rfq.User.firstName + " " + rfq.User.lastName).trim() || "-"}}</strong>
                                <a ng-show="(rfq.User.firstName + ' ' + rfq.User.lastName).trim() == ''" class="btn btn-primary pull-right" href="#" ng-click="assignToMeRfq(rfq.id)">Assign to Me</a>
                            </div>
                        </div>
                        <strong ng-show="isPoReceived(rfq)">{{(rfq.User.firstName + " " + rfq.User.lastName).trim() || "-"}}</strong>

                        <br />
                        <div class="lblMsg"></div>
                        <input type="hidden" class="hdnUserId" value="{{rfq.UserId}}">
                        <input type="hidden" class="hdnRfqId" value="{{rfq.id}}" />
                    </div>
                </div>
                <div class="clear clearfix"></div><br />
                <div class="row">
                    <ul id="carousel" class="elastislide">
                        <li data-ng-repeat="image in rfq.RfqImages| orderBy : '-createdAt'">
                            <a data-fancybox="gallery" href="{{image.imagePath}}">                              
                                   <img src="{{image.displayPath}}" alt="image{{image.id}}"   />
                            </a>
                        </li>
                    </ul>
                </div>

            </div>
            <div class="col-lg-6">
                <div ng-include="'views/rfqs/rfqComments.html'"></div>
            </div>
        </div>

        <div class="clear clearfix"></div> <br />
        <hr />

        <div class="row">
            <div ng-include="'views/rfqs/rfqLeftNavigation.htm'" class="col col-lg-12"></div>
            <div class="col col-lg-12">
                <h3><strong>Email Content</strong></h3>
                <div class="clear clearfix"></div> <br />
                <div style=" overflow:auto; max-height 300px">
                    <p ng-bind-html="trustAsHtml(rfq.content)"></p>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            $(document).ready(function () {
                //   console.log($scope);
                var loadCode = setInterval(function () {
                    if ($(".elastislide").length > 0) {
                        $('.elastislide').elastislide();
                    }
                    if ($(".hdnUserId").val() != "") {
                        $(".ddlUser option[selected]").remove();
                        $(".ddlUser").val($(".hdnUserId").val());
                    }

                    $(".ddlUser").on('change', function () {
                        var $me = $(this);
                        var rfqId = $('.hdnRfqId').val();
                        var ddlUserId = $(this).val();
                        $.ajax({
                            url: '/rfqs/' + rfqId,
                            method: "PUT",
                            data: { UserId: ddlUserId, id: rfqId }
                        }).done(function (response) {
                            if ($me.val() == "") {
                                $(".lblMsg").html("<span>RFQ assigned to nobody</span>").addClass("alert alert-success");
                            } else {
                                $(".lblMsg").html("<span>RFQ assigned to " + $me.find("option:selected").text() + "</span>").addClass("alert alert-success");
                            }
                        });
                    });
                    if ($(".hdnRfqId").length > 0 && $(".hdnRfqId").val() != "") {
                        clearInterval(loadCode);
                    }
                }, 500);
            });
        </script>
    </section>
    <section ng-show="rfq.id == null && validatePermission">
        <h1>403 - Forbidden</h1>
        <p>Access Denied. You don't have access to view this page</p>
    </section>

    <section ng-show="!validatePermission">
        <h1>Loading please wait..!!</h1>
        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%">
            </div>
        </div>
    </section>
</div>

